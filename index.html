<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PropertyFlow Bond Token Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .card {
            background-color: white;
            border-radius: 0.75rem;
            border: 1px solid #e5e7eb;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            transition: all 0.3s ease-in-out;
        }
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.75rem 1.5rem;
            font-weight: 500;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            border: 1px solid transparent;
        }
        .btn-primary {
            background-color: #4f46e5;
            color: white;
        }
        .btn-primary:hover {
            background-color: #4338ca;
        }
        .btn-primary:disabled {
            background-color: #a5b4fc;
            cursor: not-allowed;
        }
        .btn-secondary {
            background-color: #f3f4f6;
            color: #1f2937;
            border: 1px solid #d1d5db;
        }
        .btn-secondary:hover {
            background-color: #e5e7eb;
        }
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }
        .info-item {
            background-color: #f9fafb;
            padding: 1rem;
            border-radius: 0.5rem;
        }
        .info-item .title { font-size: 0.875rem; color: #6b7280; margin-bottom: 0.25rem; }
        .info-item .value { font-size: 1.125rem; font-weight: 600; color: #1f2937; word-wrap: break-word; }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4f46e5;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #notification {
            position: fixed; bottom: 20px; right: 20px; padding: 1rem 1.5rem;
            border-radius: 0.5rem; color: white; display: none; z-index: 100;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .notification-success { background-color: #10b981; }
        .notification-error { background-color: #ef4444; }

        /* Toggle Switch Styles */
        .toggle-container { display: flex; align-items: center; gap: 0.75rem; }
        .toggle-label { font-size: 0.875rem; font-weight: 500; color: #374151; }
        .toggle-switch { position: relative; display: inline-block; width: 60px; height: 34px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .toggle-slider {
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
            background-color: #ccc; transition: .4s; border-radius: 34px;
        }
        .toggle-slider:before {
            position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px;
            background-color: white; transition: .4s; border-radius: 50%;
        }
        input:checked + .toggle-slider { background-color: #4f46e5; }
        input:checked + .toggle-slider:before { transform: translateX(26px); }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div id="app" class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
        <!-- Header -->
        <header class="flex flex-col sm:flex-row justify-between items-center mb-4">
            <h1 class="text-3xl font-bold text-gray-900 mb-4 sm:mb-0">PropertyFlow Bond Token Dashboard</h1>
            <div class="flex items-center gap-4">
                <div class="toggle-container">
                    <span class="toggle-label">Arbitrum</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="networkToggle">
                        <span class="toggle-slider"></span>
                    </label>
                    <span class="toggle-label">Plume</span>
                </div>
                <button id="connectButton" class="btn btn-primary">Connect Wallet</button>
            </div>
        </header>

        <!-- Description Card -->
        <div class="card bg-indigo-50 border-indigo-200 mb-8">
            <p class="text-center text-indigo-800">
                PropertyFlow is a real-world asset (RWA) bond system that tokenizes commercial lease and overhead payments.
                Buy PFLOW25 for $10 and earn $12 after 12 months. Available for a limited time â€” cutoff at 9 months. Early redemption allowed after 45 days at a reduced rate. Fractional purchases supported.
            </p>
        </div>

        <!-- Main Content -->
        <main id="mainContent" class="hidden">
             <div class="card mb-6">
                <h2 class="text-xl font-semibold mb-4 text-gray-800">Connection Status</h2>
                <div class="info-grid">
                    <div class="info-item">
                        <div class="title">Account</div>
                        <div id="userAddress" class="value truncate">Not Connected</div>
                    </div>
                    <div class="info-item">
                        <div class="title">Network</div>
                        <div id="networkName" class="value">N/A</div>
                    </div>
                </div>
            </div>
            
            <div id="contractUi" class="hidden space-y-6">
                <!-- Contract Info -->
                <div class="card">
                    <h2 class="text-xl font-semibold mb-4 text-gray-800">Contract Details</h2>
                     <div id="contractInfoLoader" class="flex justify-center items-center h-24"><div class="loader"></div></div>
                    <div id="contractInfo" class="info-grid hidden">
                        <div class="info-item"><div class="title">Name</div><div class="value" id="contractName">--</div></div>
                        <div class="info-item"><div class="title">Symbol</div><div class="value" id="contractSymbol">--</div></div>
                        <div class="info-item"><div class="title">Total Supply</div><div class="value" id="totalSupply">--</div></div>
                        <div class="info-item"><div class="title">Max Supply</div><div class="value" id="maxSupply">--</div></div>
                        <div class="info-item"><div class="title">Maturity</div><div class="value" id="maturityDate">--</div></div>
                        <div class="info-item"><div class="title" id="purchasePriceLabel">Purchase Price</div><div class="value" id="purchasePrice">--</div></div>
                        <div class="info-item"><div class="title" id="redeemRateLabel">Maturity Payout</div><div class="value" id="redeemRate">--</div></div>
                        <div class="info-item"><div class="title" id="earlyRedeemRateLabel">Early Payout</div><div class="value" id="earlyRedeemRate">--</div></div>
                        <div class="info-item"><div class="title">Contract Owner</div><div class="value truncate" id="contractOwner">--</div></div>
                    </div>
                </div>

                <!-- User Info -->
                 <div class="card">
                    <h2 class="text-xl font-semibold mb-4 text-gray-800">Your Holdings</h2>
                    <div class="info-grid">
                        <div class="info-item"><div class="title">Your Token Balance</div><div class="value" id="userTokenBalance">--</div></div>
                        <div class="info-item"><div class="title" id="currencyBalanceLabel">Your Currency Balance</div><div class="value" id="userCurrencyBalance">--</div></div>
                        <div class="info-item"><div class="title" id="currencyAllowanceLabel">Your Currency Allowance</div><div class="value" id="currencyAllowance">--</div></div>
                    </div>
                </div>

                <!-- Actions -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Buy Card -->
                    <div class="card">
                        <h3 class="text-lg font-semibold mb-3">Buy Tokens</h3>
                        <p class="text-sm text-gray-500 mb-4" id="buyCardDescription">Purchase tokens. You must first approve the contract to spend your currency.</p>
                        <div class="space-y-4">
                            <div>
                                <label for="buyAmount" class="label" id="buyAmountLabel">Amount</label>
                                <input type="number" id="buyAmount" placeholder="Enter amount to spend">
                            </div>
                            <div class="flex flex-col sm:flex-row gap-2">
                                <button id="approveButton" class="btn btn-secondary flex-1">1. Approve</button>
                                <button id="buyButton" class="btn btn-primary flex-1">2. Buy</button>
                            </div>
                        </div>
                    </div>

                    <!-- Redeem Card -->
                    <div class="card">
                        <h3 class="text-lg font-semibold mb-3">Redeem Tokens</h3>
                        <p class="text-sm text-gray-500 mb-4" id="redeemCardDescription">Redeem your tokens. Early redemption has a different rate.</p>
                        <div class="flex flex-col sm:flex-row gap-2">
                            <button id="redeemButton" class="btn btn-primary flex-1">Redeem (at Maturity)</button>
                            <button id="earlyRedeemButton" class="btn btn-secondary flex-1">Redeem Early</button>
                        </div>
                    </div>

                    <!-- Transfer Card -->
                     <div class="card">
                        <h3 class="text-lg font-semibold mb-3">Transfer Tokens</h3>
                        <div class="space-y-4">
                             <div>
                                <label for="transferAddress" class="label">Recipient Address</label>
                                <input type="text" id="transferAddress" placeholder="0x...">
                            </div>
                            <div>
                                <label for="transferAmount" class="label">Amount</label>
                                <input type="number" id="transferAmount" placeholder="Enter amount to transfer">
                            </div>
                            <button id="transferButton" class="btn btn-primary w-full">Transfer</button>
                        </div>
                    </div>

                    <!-- Admin Panel -->
                    <div id="adminPanel" class="card hidden">
                        <h3 class="text-lg font-semibold mb-3">Admin Panel (Owner Only)</h3>
                        <div class="space-y-4">
                            <div class="flex flex-col sm:flex-row gap-2">
                                <button id="enableTransfersButton" class="btn btn-secondary flex-1">Enable Transfers</button>
                                 <button id="emergencyWithdrawButton" class="btn btn-secondary flex-1 bg-red-100 border-red-300 text-red-700 hover:bg-red-200">Emergency Withdraw</button>
                            </div>
                            <div>
                                <label for="fundVaultAmount" class="label" id="fundVaultLabel">Fund Vault</label>
                                <div class="flex gap-2">
                                    <input type="number" id="fundVaultAmount" placeholder="Amount" class="flex-grow">
                                    <button id="fundVaultButton" class="btn btn-secondary">Fund</button>
                                </div>
                            </div>
                             <div>
                                <label for="newOwnerAddress" class="label">Transfer Ownership</label>
                                <div class="flex gap-2">
                                    <input type="text" id="newOwnerAddress" placeholder="New owner address" class="flex-grow">
                                    <button id="transferOwnershipButton" class="btn btn-secondary">Transfer</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Notification element -->
    <div id="notification"></div>

<script>
    // --- Application State ---
    let provider;
    let signer;
    let userAddress;
    let contract;
    let currencyContract;
    let selectedNetwork = 'arbitrum'; // Default network

    // --- Network & Contract Configuration ---
    const networks = {
        arbitrum: {
            chainId: '0xa4b1', // 42161 in hex for Arbitrum One
            chainName: 'Arbitrum One',
            contractAddress: '0xd0dc6eeE2dD77d7A4C09108993d0c7ad6a0b60E3',
            currencySymbol: 'USDC',
            contractGetter: 'usdc', // Function name in the contract to get the currency address
        },
        plume: {
            chainId: '0x18232', // 98866 in hex
            chainName: 'Plume',
            contractAddress: '0x14b3Fa2d3627ca1EC8042c9d33Bad94F72CEEe7f', 
            nativeCurrency: { name: 'Plume', decimals: 18, symbol: 'PLUME' },
            rpcUrls: ['https://rpc.plume.org'],
            blockExplorerUrls: ['https://explorer.plume.org'],
            currencySymbol: 'pUSD',
            contractGetter: 'pUSD', // Function name in the contract to get the currency address
        }
    };

    // --- ABI Definitions ---
    // This ABI is a superset of both contracts to ensure all functions can be called.
    const contractAbi = [{"inputs":[{"internalType":"address","name":"usdcAddress","type":"address"},{"internalType":"uint256","name":"_purchasePrice","type":"uint256"},{"internalType":"uint256","name":"_redeemRate","type":"uint256"},{"internalType":"uint256","name":"_earlyRedeemRate","type":"uint256"},{"internalType":"uint256","name":"_durationSeconds","type":"uint256"}],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":true,"internalType":"address","name":"spender","type":"address"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"Approval","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"payout","type":"uint256"}],"name":"EarlyRedeemed","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"previousOwner","type":"address"},{"indexed":true,"internalType":"address","name":"newOwner","type":"address"}],"name":"OwnershipTransferred","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"payout","type":"uint256"}],"name":"Redeemed","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"from","type":"address"},{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"Transfer","type":"event"},{"inputs":[],"name":"MAX_SUPPLY","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"},{"internalType":"address","name":"","type":"address"}],"name":"allowance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"spender","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"approve","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"buy","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"decimals","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"earlyRedeem","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"earlyRedeemRate","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"emergencyWithdraw","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"enableTransfers","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"fundVault","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"lastBuyTimestamp","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"maturity","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"name","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"pUSD","outputs":[{"internalType":"contract IERC20","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"usdc","outputs":[{"internalType":"contract IERC20","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"purchasePrice","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"redeem","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"redeemRate","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"symbol","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalSupply","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"transfer","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"from","type":"address"},{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"transferFrom","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"newOwner","type":"address"}],"name":"transferOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"transfersEnabled","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"usdcBalance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"}];
    const currencyAbi = [ "function name() view returns (string)", "function symbol() view returns (string)", "function decimals() view returns (uint8)", "function balanceOf(address) view returns (uint256)", "function allowance(address owner, address spender) view returns (uint256)", "function approve(address spender, uint256 amount) returns (bool)"];

    // --- DOM Elements ---
    const connectButton = document.getElementById('connectButton');
    const networkToggle = document.getElementById('networkToggle');
    const mainContent = document.getElementById('mainContent');
    const userAddressEl = document.getElementById('userAddress');
    const networkNameEl = document.getElementById('networkName');
    const contractUi = document.getElementById('contractUi');
    const notificationEl = document.getElementById('notification');
    
    // --- UI Update & Utility Functions ---
    const showNotification = (message, isError = false) => {
        notificationEl.textContent = message;
        notificationEl.className = isError ? 'notification-error' : 'notification-success';
        notificationEl.style.display = 'block';
        setTimeout(() => { notificationEl.style.display = 'none'; }, 5000);
    };

    const setLoadingState = (button, isLoading, originalText = '') => {
        if (isLoading) {
            button.disabled = true;
            button.innerHTML = '<div class="loader"></div>';
        } else {
            button.disabled = false;
            button.innerHTML = originalText;
        }
    };
    
    // --- Core Web3 Functions ---

    async function switchNetwork(networkKey) {
        if (!provider) {
            showNotification("Please connect your wallet first.", true);
            return false;
        }
        const targetNetwork = networks[networkKey];
        try {
            await provider.send('wallet_switchEthereumChain', [{ chainId: targetNetwork.chainId }]);
            return true;
        } catch (switchError) {
            if (switchError.code === 4902 && targetNetwork.rpcUrls) {
                try {
                    await provider.send('wallet_addEthereumChain', [
                        {
                            chainId: targetNetwork.chainId,
                            chainName: targetNetwork.chainName,
                            nativeCurrency: targetNetwork.nativeCurrency,
                            rpcUrls: targetNetwork.rpcUrls,
                            blockExplorerUrls: targetNetwork.blockExplorerUrls,
                        }
                    ]);
                    return true;
                } catch (addError) {
                    showNotification(`Failed to add ${targetNetwork.chainName} to your wallet.`, true);
                    return false;
                }
            }
            showNotification("Failed to switch network. Please do it manually in your wallet.", true);
            return false;
        }
    }

    async function connectWallet() {
        if (typeof window.ethereum === 'undefined') {
            showNotification("MetaMask is not installed. Please install it to use this app.", true);
            return;
        }
        
        setLoadingState(connectButton, true);
        try {
            provider = new ethers.providers.Web3Provider(window.ethereum);
            await provider.send("eth_requestAccounts", []);
            signer = provider.getSigner();
            userAddress = await signer.getAddress();
            
            const network = await provider.getNetwork();
            const targetNetwork = networks[selectedNetwork];

            if (network.chainId !== parseInt(targetNetwork.chainId, 16)) {
                showNotification(`Please switch to the ${targetNetwork.chainName} network.`, false);
                const switched = await switchNetwork(selectedNetwork);
                if (!switched) {
                     setLoadingState(connectButton, false, 'Connect Wallet');
                     networkToggle.checked = selectedNetwork === 'plume';
                     return;
                }
                return;
            }

            setLoadingState(connectButton, false, 'Wallet Connected');
            connectButton.disabled = true;
            mainContent.classList.remove('hidden');
            userAddressEl.textContent = `${userAddress.substring(0, 6)}...${userAddress.substring(userAddress.length - 4)}`;
            networkNameEl.textContent = networks[selectedNetwork].chainName;
            
            await loadContract();
            
            window.ethereum.on('accountsChanged', () => window.location.reload());
            window.ethereum.on('chainChanged', () => window.location.reload());

        } catch (error) {
            console.error("Connection failed:", error);
            showNotification("Wallet connection was rejected.", true);
            setLoadingState(connectButton, false, 'Connect Wallet');
        }
    }

    async function loadContract() {
        const currentNetworkConfig = networks[selectedNetwork];
        if (!ethers.utils.isAddress(currentNetworkConfig.contractAddress)) {
            showNotification(`Invalid contract address for ${currentNetworkConfig.chainName}.`, true);
            return;
        }

        try {
            contract = new ethers.Contract(currentNetworkConfig.contractAddress, contractAbi, provider);
            const currencyAddress = await contract[currentNetworkConfig.contractGetter]();
            currencyContract = new ethers.Contract(currencyAddress, currencyAbi, provider);
            
            contractUi.classList.remove('hidden');
            await updateContractInfo();
        } catch (error) {
            console.error("Failed to load contract:", error);
            showNotification(`Failed to load contract on ${currentNetworkConfig.chainName}. Is the correct ABI being used?`, true);
            contractUi.classList.add('hidden');
        }
    }

    async function updateContractInfo() {
        const infoEl = document.getElementById('contractInfo');
        const loaderEl = document.getElementById('contractInfoLoader');
        const currencySymbol = networks[selectedNetwork].currencySymbol;

        infoEl.classList.add('hidden');
        loaderEl.classList.remove('hidden');

        // Dynamically update labels based on network
        document.getElementById('purchasePriceLabel').textContent = `Purchase Price (${currencySymbol})`;
        document.getElementById('currencyBalanceLabel').textContent = `Your ${currencySymbol} Balance`;
        document.getElementById('currencyAllowanceLabel').textContent = `Your ${currencySymbol} Allowance`;
        document.getElementById('buyAmountLabel').textContent = `${currencySymbol} Amount`;
        document.getElementById('buyCardDescription').textContent = `Purchase tokens with ${currencySymbol}. You must first approve the contract to spend your ${currencySymbol}.`;
        document.getElementById('redeemCardDescription').textContent = `Redeem your tokens for ${currencySymbol}. Early redemption has a different rate.`;
        document.getElementById('fundVaultLabel').textContent = `Fund Vault (${currencySymbol})`;


        try {
            const hasMaxSupply = contract.functions.MAX_SUPPLY;
            
            const promises = [
                contract.name(), contract.symbol(), contract.totalSupply(),
                contract.maturity(), contract.purchasePrice(), contract.redeemRate(),
                contract.earlyRedeemRate(), contract.owner(), contract.decimals()
            ];

            if (hasMaxSupply) {
                promises.splice(3, 0, contract.MAX_SUPPLY());
            } else {
                 promises.splice(3, 0, Promise.resolve(null)); 
            }
            
            const [name, symbol, totalSupply, maxSupply, maturity, purchasePrice, redeemRate, earlyRedeemRate, owner, decimals] = await Promise.all(promises);

            document.getElementById('contractName').textContent = name;
            document.getElementById('contractSymbol').textContent = symbol;
            document.getElementById('totalSupply').textContent = ethers.utils.formatUnits(totalSupply, decimals);
            
            if (maxSupply !== null) {
                document.getElementById('maxSupply').parentElement.style.display = 'block';
                document.getElementById('maxSupply').textContent = ethers.utils.formatUnits(maxSupply, decimals);
            } else {
                 document.getElementById('maxSupply').parentElement.style.display = 'none';
            }
            
            document.getElementById('maturityDate').textContent = new Date(maturity.toNumber() * 1000).toLocaleString();
            
            const currencyDecimals = await currencyContract.decimals();
            
            // --- CORRECTED BIG NUMBER MATH & FORMATTING ---
            const purchasePriceBN = purchasePrice;
            const redeemRateBN = redeemRate;
            const earlyRedeemRateBN = earlyRedeemRate;
            
            // Divisor logic for rates. This handles rates stored as percentages with precision.
            // e.g., 120% is stored as 120 * 10^18. We divide by 100 * 10^18.
            const rateDivisor = ethers.BigNumber.from('10').pow(18).mul(100);

            // Calculate payouts using BigNumber math to prevent overflow
            const maturityPayoutBN = purchasePriceBN.mul(redeemRateBN).div(rateDivisor);
            const earlyPayoutBN = purchasePriceBN.mul(earlyRedeemRateBN).div(rateDivisor);
            
            // Format the final results for display
            const formattedPrice = parseFloat(ethers.utils.formatUnits(purchasePriceBN, currencyDecimals)).toFixed(2);
            const formattedMaturityPayout = parseFloat(ethers.utils.formatUnits(maturityPayoutBN, currencyDecimals)).toFixed(2);
            const formattedEarlyPayout = parseFloat(ethers.utils.formatUnits(earlyPayoutBN, currencyDecimals)).toFixed(2);

            document.getElementById('purchasePrice').textContent = `${formattedPrice} ${currencySymbol}`;
            document.getElementById('redeemRate').textContent = `${formattedMaturityPayout} ${currencySymbol}`;
            document.getElementById('earlyRedeemRate').textContent = `${formattedEarlyPayout} ${currencySymbol}`;
            // --- END CORRECTION ---

            document.getElementById('redeemRateLabel').textContent = 'Maturity Payout';
            document.getElementById('earlyRedeemRateLabel').textContent = 'Early Payout';
            document.getElementById('contractOwner').textContent = owner;
            
            await updateUserInfo();
            checkOwnerStatus(owner);
        } catch (error) {
            console.error("Failed to fetch contract info:", error);
            showNotification("Could not load contract data.", true);
        } finally {
             loaderEl.classList.add('hidden');
             infoEl.classList.remove('hidden');
        }
    }
    
    async function updateUserInfo() {
        if (!contract || !userAddress || !currencyContract) return;
        const currentNetworkConfig = networks[selectedNetwork];
        try {
            const [tokenBalance, currencyBalance, allowance, contractDecimals, currencyDecimals] = await Promise.all([
                contract.balanceOf(userAddress),
                currencyContract.balanceOf(userAddress),
                currencyContract.allowance(userAddress, currentNetworkConfig.contractAddress),
                contract.decimals(),
                currencyContract.decimals()
            ]);

            document.getElementById('userTokenBalance').textContent = ethers.utils.formatUnits(tokenBalance, contractDecimals);
            document.getElementById('userCurrencyBalance').textContent = ethers.utils.formatUnits(currencyBalance, currencyDecimals);
            document.getElementById('currencyAllowance').textContent = ethers.utils.formatUnits(allowance, currencyDecimals);
        } catch (error) {
            console.error("Failed to fetch user info:", error);
        }
    }
    
    function checkOwnerStatus(owner) {
        const adminPanel = document.getElementById('adminPanel');
        if (userAddress && owner && userAddress.toLowerCase() === owner.toLowerCase()) {
            adminPanel.classList.remove('hidden');
        } else {
            adminPanel.classList.add('hidden');
        }
    }

    async function handleTransaction(txFunction, button, successMessage, originalText) {
        setLoadingState(button, true);
        try {
            const tx = await txFunction();
            showNotification(`Transaction sent: ${tx.hash.substring(0, 10)}...`);
            await tx.wait();
            showNotification(successMessage, false);
            await updateContractInfo(); 
        } catch (error) {
            console.error("Transaction failed:", error);
            const errorMessage = error.reason || error.data?.message || "Transaction failed.";
            showNotification(errorMessage, true);
        } finally {
            setLoadingState(button, false, originalText);
        }
    }

    // --- Event Listeners ---
    window.addEventListener('DOMContentLoaded', () => {
        connectButton.addEventListener('click', connectWallet);

        networkToggle.addEventListener('change', async (event) => {
            selectedNetwork = event.target.checked ? 'plume' : 'arbitrum';
            if (provider) {
                contractUi.classList.add('hidden');
                const switched = await switchNetwork(selectedNetwork);
                if (switched) {
                    window.location.reload(); 
                } else {
                    event.target.checked = selectedNetwork !== 'plume';
                }
            }
        });

        const approveButton = document.getElementById('approveButton');
        approveButton.addEventListener('click', async () => {
            const amount = document.getElementById('buyAmount').value;
            const currencyDecimals = await currencyContract.decimals();
            if (!amount || isNaN(amount) || amount <= 0) return showNotification("Please enter a valid amount to approve.", true);
            const parsedAmount = ethers.utils.parseUnits(amount, currencyDecimals);
            const txFunction = () => currencyContract.connect(signer).approve(networks[selectedNetwork].contractAddress, parsedAmount);
            await handleTransaction(txFunction, approveButton, "Approval successful!", "1. Approve");
        });

        const buyButton = document.getElementById('buyButton');
        buyButton.addEventListener('click', async () => {
            const amount = document.getElementById('buyAmount').value;
            const currencyDecimals = await currencyContract.decimals();
            if (!amount || isNaN(amount) || amount <= 0) return showNotification("Please enter a valid amount to buy.", true);
            const parsedAmount = ethers.utils.parseUnits(amount, currencyDecimals);
            const txFunction = () => contract.connect(signer).buy(parsedAmount);
            await handleTransaction(txFunction, buyButton, "Purchase successful!", "2. Buy");
        });
        
        const redeemButton = document.getElementById('redeemButton');
        redeemButton.addEventListener('click', async () => {
            const txFunction = () => contract.connect(signer).redeem();
            await handleTransaction(txFunction, redeemButton, "Redemption successful!", "Redeem (at Maturity)");
        });
        
        const earlyRedeemButton = document.getElementById('earlyRedeemButton');
        earlyRedeemButton.addEventListener('click', async () => {
            const txFunction = () => contract.connect(signer).earlyRedeem();
            await handleTransaction(txFunction, earlyRedeemButton, "Early redemption successful!", "Redeem Early");
        });

        const transferButton = document.getElementById('transferButton');
        transferButton.addEventListener('click', async () => {
            const to = document.getElementById('transferAddress').value;
            const amount = document.getElementById('transferAmount').value;
            const contractDecimals = await contract.decimals();
            if (!ethers.utils.isAddress(to)) return showNotification("Invalid recipient address.", true);
            if (!amount || isNaN(amount) || amount <= 0) return showNotification("Please enter a valid amount to transfer.", true);
            const parsedAmount = ethers.utils.parseUnits(amount, contractDecimals);
            const txFunction = () => contract.connect(signer).transfer(to, parsedAmount);
            await handleTransaction(txFunction, transferButton, "Transfer successful!", "Transfer");
        });

        const enableTransfersButton = document.getElementById('enableTransfersButton');
        enableTransfersButton.addEventListener('click', async () => {
             const txFunction = () => contract.connect(signer).enableTransfers();
             await handleTransaction(txFunction, enableTransfersButton, "Transfers enabled!", "Enable Transfers");
        });

        const emergencyWithdrawButton = document.getElementById('emergencyWithdrawButton');
        emergencyWithdrawButton.addEventListener('click', async () => {
            const hasUsdcBalance = contract.functions.usdcBalance;
            const balance = hasUsdcBalance ? await contract.usdcBalance() : await contract.pUSDBalance(); // Hypothetical future-proof
            if (balance.isZero()) return showNotification(`Contract has no ${networks[selectedNetwork].currencySymbol} to withdraw.`, true);
             const txFunction = () => contract.connect(signer).emergencyWithdraw(balance);
             await handleTransaction(txFunction, emergencyWithdrawButton, "Emergency withdraw successful!", "Emergency Withdraw");
        });

        const fundVaultButton = document.getElementById('fundVaultButton');
        fundVaultButton.addEventListener('click', async () => {
            const amount = document.getElementById('fundVaultAmount').value;
            const currencyDecimals = await currencyContract.decimals();
            if (!amount || isNaN(amount) || amount <= 0) return showNotification("Please enter a valid amount to fund.", true);
            const parsedAmount = ethers.utils.parseUnits(amount, currencyDecimals);
            const txFunction = () => contract.connect(signer).fundVault(parsedAmount);
            await handleTransaction(txFunction, fundVaultButton, "Vault funded successfully!", "Fund");
        });

        const transferOwnershipButton = document.getElementById('transferOwnershipButton');
        transferOwnershipButton.addEventListener('click', async () => {
            const newOwner = document.getElementById('newOwnerAddress').value;
             if (!ethers.utils.isAddress(newOwner)) return showNotification("Invalid new owner address.", true);
            const txFunction = () => contract.connect(signer).transferOwnership(newOwner);
            await handleTransaction(txFunction, transferOwnershipButton, "Ownership transferred!", "Transfer");
        });
    });
</script>
</body>
</html>
